<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
<script src="utility.js" type="text/javascript"></script>
<script src="OatyStats.js" type="text/javascript"></script>
<script src="../z_Dependencies/dynamicTextBoxes.js" type="text/javascript"></script>
<script src="../z_Dependencies/jquery.js" type="text/javascript"></script>
<script src="../z_Dependencies/jquery.transit.js" type="text/javascript"></script>
<script src="../z_Dependencies/xjs.js" type="text/javascript"></script>
<script src="../z_Dependencies/countries.js" type="text/javascript"></script>
<link rel = "stylesheet"
   type = "text/css"
   href = "Oatylayout.css" />
</head>
<body>
<p style="color:red;" id="p1" class="resizable"></p>
<p style="color:red;" id="p1SetScore">-</p>
<p style="color:red;" id="p1MatchScore">-</p>
<p style="color:red;" id="p1RecentWin">-</p>

<p style="color:red;" id="p2" class="resizable"></p>
<p style="color:red;" id="p2SetScore">-</p>
<p style="color:red;" id="p2MatchScore">-</p>
<p style="color:red;" id="p2RecentWin">-</p>

<p style="color:green;" id="debug">Loading</p>
<p style="color:green;font-size:100%;" id="debug2">~</p>
<p style="color:green;font-size:200%;" id="debug3">~</p>

<script type="text/javascript">

function loadingFn(loadingEvent){
	if (loadingEvent.getEventType() == EventType.INFO){
		setContent("debug2", loadingEvent.getMessage());
	} else if (loadingEvent.getEventType() == EventType.DEBUG){
		setContent("debug3", loadingEvent.getMessage());
	} else{
		setContent("debug", "Loading... " + loadingEvent.getMessage() + " tournaments");
	}
}

async function run(){
	var tournament = "simbarumba-2"; // Must include both players in this tournament.
	
	setContent("p1", Player_One);
	setContent("p2", Player_Two);

	var h2h = await getHeadToHead(Player_One, Player_Two, tournament, loadingFn);
	
	setContent("p1SetScore", h2h.getSetCount().getP1Score());
	setContent("p1MatchScore", h2h.getMatchCount().getP1Score());
	let p1RecentWin = h2h.getMostRecentWins()[0];
	setContent("p1RecentWin", "Most Recent Win: " + "(" + p1RecentWin.toDateString() + ")");
	
	setContent("p2SetScore", h2h.getSetCount().getP2Score());
	setContent("p2MatchScore", h2h.getMatchCount().getP2Score());
	
	let p2RecentWin = h2h.getMostRecentWins()[1];
	setContent("p2RecentWin", "Most Recent Win: " + "(" + p2RecentWin.toDateString() + ")");
}
	
		//JSON file containing all current game information
	var StreamJSON = '../z_Dependencies/settings.json';
	var Score_One;
	var Country_One;
    var Port_One;
    var Character_One;
	var Player_One;
	var Score_Two;
	var Country_Two;
    var Port_Two;
	var Character_Two;
	var Player_Two;            
	var Commentator_One;
	var Commentator_Two;
	var Round1;
	var Round1;

	//var Breaking_News;

	function readFromJson(StreamJSON){
		$.getJSON(StreamJSON, function(d){
			Score_One = d.Score_One;
			Score_Two = d.Score_Two;

			Country_One = d.Country_One;
			Player_One = d.Player_One;
            Port_One = "P" + d.Port_One;

			Country_Two = d.Country_Two;
			Player_Two = d.Player_Two;
            Port_Two = "P" + d.Port_Two;

            
			Round1 = d.Round;

			//Breaking_News = d.Breaking_News;
		});
	}
	
	function updateContent(container, newContent) {
		$(container).html(newContent); 
		
		// Only resize containers marked as resizable
		if ($(container).hasClass("resizable")){
			resize(container);
		}
  }
	
	function updateContentFadeDelayed(container, newContent, delay, time){	
		$(container).transition(
			{opacity: "0"},
			time
		)
		.queue(function(){
			updateContent(container, newContent);
			$(container).dequeue();
			})
		.transition({opacity: '1'}, time);
		
	}
	
	function Build() {
  		var xjs = require('xjs');
  		var App = new xjs.App();
  		var XJSitem;
  		var XJSframe = null;

  		xjs.ready().then(xjs.Source.getCurrentSource).then(function(curItem) {
  			App.getVersion().then(function(res) {
  				var version = res;
  				console.log(version);
  			});
			
  			isXsplit = true;

  			XJSitem = curItem;

  			XJSitem.setBrowserCustomSize(xjs.Rectangle.fromDimensions(1280,720));
  			XJSitem.setPosition(xjs.Rectangle.fromCoordinates(0,0,1,1));
  			XJSitem.setPositionLocked(true);
  			window.external.SetLocalProperty("prop:Browser60fps","1");

			XJSitem.getSceneId().then(function(scene) {
				xjs.Scene.getByIdAsync(scene).then(function(scene) {
					return scene.getSources();
				}).then(function(items) {
					for (var i in items) {
						if(items[i]._name.indexOf('.webm') != -1) {
							items[i].setActionAfterPlayback(2);
							items[i].setAutostartOnSceneLoad(true);
							items[i].setRememberingPlaybackPosition(false);
							items[i].setVisible(true);
							items[i].setPosition(xjs.Rectangle.fromCoordinates(0,0,1,1));
							items[i].setPlaying(true);
							items[i].setFullDynamicColorRange(false);
						}
					}
				});
			});
		});
	}
	
	function Updates() {
		readFromJson(StreamJSON);

		
        if ($("#STOne").text() != Country_One) {
			updateContent('#STOne', Country_One);
			updateContentFadeDelayed('#Country_One', '<img src="../z_Dependencies/Logos/'+ Country_One +'.png" width="64" onerror="this.style.display=\'none\'" />', 250, 600);
		}
				
        if ($("#STTwo").text() != Country_Two) {
			updateContent('#STTwo', Country_Two);
			updateContentFadeDelayed('#Country_Two', '<img src="../z_Dependencies/Logos/'+ Country_Two +'.png" width="64" onerror="this.style.display=\'none\'" />', 250, 600);
		}

		if ($("#Player_One").text() != Player_One) {
			updateContentFadeDelayed('#Player_One', Player_One, 300, 600);
		}

		if ($("#Player_Two").text() != Player_Two) {
			updateContentFadeDelayed('#Player_Two', Player_Two, 300, 600);
		}
        
        if ($("#Port_One").text() != Port_One) {
			updateContentFadeDelayed('#Port_One', Port_One, 300, 600);
		}
        
        if ($("#Port_Two").text() != Port_Two) {
			updateContentFadeDelayed('#Port_Two', Port_Two, 300, 600);
		}

		if ($("#Score_One").text() != Score_One) {
			updateContentFadeDelayed('#Score_One', Score_One, 300, 600);
		}

		if ($("#Score_Two").text() != Score_Two) {
			updateContentFadeDelayed('#Score_Two', Score_Two, 300, 600);
		}

		if ($("#Round1").text() != Round1) {
			updateContentFadeDelayed('#Round1', Round1, 250, 600);
		}
		setTicker();
	}
  
    //Build the Displayed scene
    Build();
  
    //Start overlay layout update loop
    setInterval (function() { Updates(); }, 1000);

	setTimeout (function() { InitialTicker(); }, 1000);

	setInterval (function() { FetchResults(); }, 10000);


run();
</script>

</body>
</html>
